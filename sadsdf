import json
import pandas as pd
from datetime import datetime

TEAM_MAP = {
    "Man City": "Manchester City",
    "Man United": "Manchester United",
    "Spurs": "Tottenham",
    "Newcastle": "Newcastle United",
    "Wolves": "Wolverhampton Wanderers",
    "West Ham": "West Ham United",
    "Nott'm Forest": "Nottingham Forest",
    "Brighton": "Brighton & Hove Albion",
    "Leicester": "Leicester City",
    "Leeds": "Leeds United",
    "Norwich": "Norwich City"
}

CSV_URL = "https://www.football-data.co.uk/mmz4281/2526/E0.csv"

print("Downloading latest results...")
df = pd.read_csv(CSV_URL)

results = {}

for _, row in df.iterrows():
    if pd.isna(row["Date"]):
        continue

    try:
        dt = datetime.strptime(row["Date"], "%d/%m/%Y").strftime("%Y-%m-%d")
    except:
        continue

    home = TEAM_MAP.get(str(row["HomeTeam"]).strip(), str(row["HomeTeam"]).strip())
    away = TEAM_MAP.get(str(row["AwayTeam"]).strip(), str(row["AwayTeam"]).strip())

    if pd.notna(row["FTHG"]) and pd.notna(row["FTAG"]):
        results[(dt, home, away)] = f"{int(row['FTHG'])}-{int(row['FTAG'])}"

print(f"Results loaded: {len(results)}")

with open("schedule.json", "r") as f:
    schedule = json.load(f)

updated = 0
debug_shown = 0

for matchday in schedule["matchdays"]:
    for match in matchday["matches"]:
        key = (match["date"], match["home"].strip(), match["away"].strip())

        if key in results:
            match["score"] = results[key]
            updated += 1
        else:
            # Show first 10 failures so we can see the mismatch
            if debug_shown < 10:
                print("NO MATCH FOUND FOR:")
                print("  JSON :", key)

                # find same date games from CSV to compare names
                same_date = [r for r in results.keys() if r[0] == match["date"]]
                if same_date:
                    print("  CSV options on same date:")
                    for opt in same_date[:3]:
                        print("   ", opt)
                else:
                    print("  ❌ No CSV games on this date")
                print()
                debug_shown += 1

with open("schedule.json", "w") as f:
    json.dump(schedule, f, indent=2)

print(f"\n✅ Updated {updated} match scores")
