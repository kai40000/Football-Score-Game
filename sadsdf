import pandas as pd
import json
from datetime import datetime

CSV_URL = "https://www.football-data.co.uk/mmz4281/2526/E0.csv"

print("Downloading latest results...")
df = pd.read_csv(CSV_URL)

# Build lookup of results
results = {}

for _, row in df.iterrows():
    if pd.isna(row["Date"]) or pd.isna(row["HomeTeam"]) or pd.isna(row["AwayTeam"]):
        continue

    try:
        dt = datetime.strptime(row["Date"], "%d/%m/%Y").strftime("%Y-%m-%d")
    except:
        continue

    if pd.notna(row["FTHG"]) and pd.notna(row["FTAG"]):
        score = f"{int(row['FTHG'])}-{int(row['FTAG'])}"
        key = (dt, row["HomeTeam"].strip(), row["AwayTeam"].strip())
        results[key] = score

print(f"Results loaded: {len(results)}")

# Load full fixtures
with open("full_schedule.json", "r") as f:
    schedule = json.load(f)

updated = 0

for matchday in schedule["matchdays"]:
    for match in matchday["matches"]:
        key = (match["date"], match["home"].strip(), match["away"].strip())

        if key in results:
            match["score"] = results[key]
            updated += 1

print(f"Updated {updated} match scores")

# Save updated schedule
with open("schedule.json", "w") as f:
    json.dump(schedule, f, indent=2)

print("âœ… schedule.json updated with latest scores")

