import requests
from bs4 import BeautifulSoup, Comment
import json
from datetime import datetime

URL = "https://fbref.com/en/comps/9/schedule/Premier-League-Scores-and-Fixtures"

headers = {"User-Agent": "Mozilla/5.0"}

def parse_date(date_str):
    try:
        return datetime.strptime(date_str.strip(), "%Y-%m-%d").strftime("%Y-%m-%d")
    except:
        return None

def find_fixture_table_in_comments(soup):
    comments = soup.find_all(string=lambda text: isinstance(text, Comment))
    for comment in comments:
        if "Scores & Fixtures" in comment or "sched" in comment:
            comment_soup = BeautifulSoup(comment, "lxml")
            table = comment_soup.find("table")
            if table:
                return table
    return None

def main():
    print("Downloading fixtures from FBref...")
    response = requests.get(URL, headers=headers)
    soup = BeautifulSoup(response.text, "lxml")

    table = find_fixture_table_in_comments(soup)
    if not table:
        print("❌ Could not find fixture table on FBref page")
        return

    matches = []
    matchday = 1
    last_date = None

    for row in table.find("tbody").find_all("tr"):
        if "thead" in row.get("class", []):
            continue

        date_cell = row.find("th", {"data-stat": "date"})
        home = row.find("td", {"data-stat": "home_team"})
        away = row.find("td", {"data-stat": "away_team"})
        score = row.find("td", {"data-stat": "score"})

        if not date_cell or not home or not away:
            continue

        parsed_date = parse_date(date_cell.text)
        if not parsed_date:
            continue

        if last_date and parsed_date != last_date:
            matchday += 1
        last_date = parsed_date

        matches.append({
            "matchday": matchday,
            "date": parsed_date,
            "home": home.text.strip(),
            "away": away.text.strip(),
            "score": score.text.strip() if score else ""
        })

    schedule = {
        "competition": "Premier League",
        "season": "2025/2026",
        "matchdays": []
    }

    md_dict = {}
    for m in matches:
        md_dict.setdefault(m["matchday"], []).append({
            "date": m["date"],
            "time": "",
            "home": m["home"],
            "away": m["away"],
            "score": m["score"]
        })

    for md in sorted(md_dict):
        schedule["matchdays"].append({
            "matchday": md,
            "matches": md_dict[md]
        })

    with open("schedule.json", "w") as f:
        json.dump(schedule, f, indent=2)

    print("✅ schedule.json created successfully!")

if __name__ == "__main__":
    main()
