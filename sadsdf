import requests
from bs4 import BeautifulSoup, Comment
import json
from datetime import datetime

URL = "https://fbref.com/en/comps/9/schedule/Premier-League-Scores-and-Fixtures"

headers = {
    "User-Agent": "Mozilla/5.0"
}

def parse_date(date_str):
    try:
        return datetime.strptime(date_str, "%Y-%m-%d").strftime("%Y-%m-%d")
    except:
        return None

def get_commented_table(soup):
    comments = soup.find_all(string=lambda text: isinstance(text, Comment))
    for c in comments:
        if "sched_" in c:
            return BeautifulSoup(c, "lxml")
    return None

def main():
    response = requests.get(URL, headers=headers)
    soup = BeautifulSoup(response.text, "lxml")

    comment_soup = get_commented_table(soup)
    if not comment_soup:
        print("Could not find commented fixture table!")
        return

    table = comment_soup.find("table")
    if not table:
        print("Could not find fixture table inside comments!")
        return

    matches = []
    matchday = 1
    last_date = None

    for row in table.tbody.find_all("tr"):
        if row.get("class") and "thead" in row.get("class"):
            continue

        date_cell = row.find("th", {"data-stat": "date"})
        home = row.find("td", {"data-stat": "home_team"})
        away = row.find("td", {"data-stat": "away_team"})
        score = row.find("td", {"data-stat": "score"})

        if not date_cell or not home or not away:
            continue

        parsed_date = parse_date(date_cell.text.strip())
        if not parsed_date:
            continue

        # New matchday when date changes
        if last_date and parsed_date != last_date:
            matchday += 1
        last_date = parsed_date

        matches.append({
            "matchday": matchday,
            "date": parsed_date,
            "home": home.text.strip(),
            "away": away.text.strip(),
            "score": score.text.strip() if score else ""
        })

    schedule = {
        "competition": "Premier League",
        "season": "2025/2026",
        "matchdays": []
    }

    md_dict = {}
    for m in matches:
        md = m["matchday"]
        md_dict.setdefault(md, []).append({
            "date": m["date"],
            "time": "",
            "home": m["home"],
            "away": m["away"],
            "score": m["score"]
        })

    for md in sorted(md_dict.keys()):
        schedule["matchdays"].append({
            "matchday": md,
            "matches": md_dict[md]
        })

    with open("schedule.json", "w") as f:
        json.dump(schedule, f, indent=2)

    print("âœ… schedule.json created successfully!")

if __name__ == "__main__":
    main()

