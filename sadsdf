import requests
from bs4 import BeautifulSoup
import json
from datetime import datetime

URL = "https://fbref.com/en/comps/9/schedule/Premier-League-Scores-and-Fixtures"

headers = {
    "User-Agent": "Mozilla/5.0"
}

def parse_date(date_str):
    try:
        return datetime.strptime(date_str, "%Y-%m-%d").strftime("%Y-%m-%d")
    except:
        return None

def main():
    response = requests.get(URL, headers=headers)
    soup = BeautifulSoup(response.text, "lxml")

    table = soup.find("table", {"id": "sched_2025-2026_9_1"})
    if not table:
        print("Could not find fixture table!")
        return

    matches = []
    matchday = 1
    last_date = None

    for row in table.tbody.find_all("tr"):
        if row.get("class") and "thead" in row.get("class"):
            continue

        cols = row.find_all("td")
        if not cols:
            continue

        date = row.find("th", {"data-stat": "date"})
        home = row.find("td", {"data-stat": "home_team"})
        away = row.find("td", {"data-stat": "away_team"})
        score = row.find("td", {"data-stat": "score"})

        if not date or not home or not away:
            continue

        date_text = date.text.strip()
        home_text = home.text.strip()
        away_text = away.text.strip()
        score_text = score.text.strip() if score else ""

        parsed_date = parse_date(date_text)
        if not parsed_date:
            continue

        # Simple matchday split by date change
        if last_date and parsed_date != last_date:
            matchday += 1
        last_date = parsed_date

        matches.append({
            "matchday": matchday,
            "date": parsed_date,
            "home": home_text,
            "away": away_text,
            "score": score_text if score_text else ""
        })

    # Convert to your app format
    schedule = {
        "competition": "Premier League",
        "season": "2025/2026",
        "matchdays": []
    }

    md_dict = {}
    for m in matches:
        md = m["matchday"]
        if md not in md_dict:
            md_dict[md] = []

        md_dict[md].append({
            "date": m["date"],
            "time": "",
            "home": m["home"],
            "away": m["away"],
            "score": m["score"]
        })

    for md in sorted(md_dict.keys()):
        schedule["matchdays"].append({
            "matchday": md,
            "matches": md_dict[md]
        })

    with open("schedule.json", "w") as f:
        json.dump(schedule, f, indent=2)

    print("schedule.json created successfully!")

if __name__ == "__main__":
    main()

